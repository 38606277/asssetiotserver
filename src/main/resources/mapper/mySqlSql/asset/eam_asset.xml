<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="eam_asset">

	<insert id="addAsset"   useGeneratedKeys="true" keyProperty="id" parameterType="Map">
		insert into eam_asset
		 (asset_tag,asset_name,iot_num,image)
		values
		 (#{asset_tag}, #{asset_name}, #{iot_num},#{image})
	</insert>
	<update id="updateAsset" parameterType="Map">
		update eam_asset set asset_tag=#{asset_tag}, asset_name=#{asset_name}, iot_num=#{iot_num},image = #{image} where asset_id=#{asset_id}
	</update>

	<delete id="deleteAsset" parameterType="map">
		delete from eam_asset where asset_id in (${asset_ids})
	</delete>

	<select id="getAssetById" resultType="map" parameterType="int">
		select e.*,CONVERT(image USING utf8mb4) AS imageBase64 from eam_asset e where e.asset_id = #{assetId}
	</select>

	<select id="queryCountByAssetId" resultType="int" parameterType="int">
		select count(asset_id) from eam_asset where asset_id = #{assetId}
	</select>


	<delete id="rmEamAsset" parameterType="int">
		delete from eam_asset where asset_id=#{assetId}
	</delete>


	<update id="bindEamTag" parameterType="Map">
		update eam_asset set iot_num = #{iot_num} where asset_id=#{asset_id}
	</update>


	<select id="listEamAssetByIotNum" resultType="Map" parameterType="Map">
		select * from eam_asset e where iot_num=#{iot_num}

	</select>

	<select id="countEamAssetByPage" resultType="int" parameterType="Map">
		select count(*) from eam_asset e
		where 1=1
		<if test="keyword != null and keyword!=''">
			and (e.asset_id like '%${keyword}%' or e.asset_num like '%${keyword}%' or e.asset_tag like '%${keyword}%' or e.asset_name like '%${keyword}%' or e.iot_num like '%${keyword}%')
		</if>
	</select>

	<select id="listEamAssetByPage" resultType="Map" parameterType="Map">
		select * ,CONVERT(image USING utf8mb4) AS imageBase64 from eam_asset e
		where 1=1
		<if test="keyword != null and keyword!=''">
			and (e.asset_id like '%${keyword}%' or e.asset_num like '%${keyword}%' or e.asset_tag like '%${keyword}%' or e.asset_name like '%${keyword}%' or e.iot_num like '%${keyword}%')
		</if>
		limit #{startIndex},#{perPage}
	</select>

	<select id="countBindingEamAssetByPage" resultType="int" parameterType="Map">
		SELECT
		count(1)
		FROM
		eam_asset e
		LEFT JOIN eam_gateway_asset g ON g.asset_id = e.asset_id
		<if test="asset_id != null and asset_id!=''">  and e.asset_id like '%${asset_id}%' </if>

	</select>

	<select id="listBindingEamAssetByPage" resultType="Map" parameterType="Map">
		SELECT
		e.*,
		g.gateway_id
		FROM
		eam_asset e
		LEFT JOIN eam_gateway_asset g ON g.asset_id = e.asset_id
		<if test="asset_id != null and asset_id!=''">  and e.asset_id like '%${asset_id}%' </if>
		limit #{startIndex},#{perPage}
	</select>


	<select id="countAssetNoBindGateway" resultType="int" parameterType="Map">
		SELECT count(1) FROM eam_asset e
		WHERE NOT EXISTS
		(SELECT 1 FROM eam_gateway_asset g
		WHERE e.asset_id = g.asset_id
		)

	</select>

	<select id="listAssetNoBindGateway" resultType="Map" parameterType="Map">
		SELECT e.* FROM eam_asset e
		WHERE NOT EXISTS
		(SELECT 1 FROM eam_gateway_asset g
		WHERE e.asset_id = g.asset_id
		)
		limit #{startIndex},#{perPage}
	</select>
	<select id="getAssetInventory" resultType="Map" parameterType="map">
		SELECT
			ea.*,
			ega.gateway_id,
			eg.address,
			eas.receive_time,
			eas.`status`,
			sa.`code`,
			sa.`name` ,
			sa.city_code
		FROM
			eam_asset ea
			LEFT JOIN eam_gateway_asset ega ON ea.asset_id = ega.asset_id
			LEFT JOIN eam_gateway eg ON ega.gateway_id = eg.gateway_id
			LEFT JOIN eam_asset_status eas ON ea.iot_num = eas.tag_id
			LEFT JOIN sys_area sa ON sa.`code` = eg.address_id
		where 1=1 <if test="receiveTime != null and receiveTime != ''"> and eas.receive_time like  concat(#{receiveTime},'%') </if>
		<if test="cityCode != null and cityCode != ''">
			and FIND_IN_SET(sa.city_code,'${cityCode}')
		</if>
	</select>
	<select id="countAssetInventory" resultType="int" parameterType="Map">
		SELECT count(1) FROM (SELECT
		ea.asset_id,
		ea.iot_num,
		ea.asset_name,
		ea.asset_num,
		ega.gateway_id,
		eg.address,
		eas.receive_time,
		eas.`status`,
		sa.`code`,
		sa.`name` ,
		sa.city_code
		FROM
		( eam_asset ea LEFT JOIN eam_gateway_asset ega ON ea.asset_id = ega.asset_id )
		LEFT JOIN eam_gateway eg ON ega.gateway_id = eg.gateway_id
		LEFT JOIN eam_asset_status eas ON ea.iot_num = eas.tag_id
		LEFT JOIN sys_area sa ON sa.`code` = eg.address_id
		-- where sa.city_code='130400000000'
		) a
	</select>


</mapper>
