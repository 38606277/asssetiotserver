<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="eam_asset">

	<insert id="addAsset"   useGeneratedKeys="true" keyProperty="id" parameterType="Map">
		insert into eam_asset
		 (asset_num,asset_name,iot_num,image)
		values
		 (#{asset_num}, #{asset_name}, #{iot_num},#{image})
	</insert>
	<update id="updateAsset" parameterType="Map">
		update eam_asset set asset_num=#{asset_num}, asset_name=#{asset_name}, iot_num=#{iot_num},image = #{image} where asset_id=#{asset_id}
	</update>

	<delete id="deleteAsset" parameterType="map">
		delete from eam_asset where asset_id in (${asset_ids})
	</delete>

	<select id="getAssetById" resultType="map" parameterType="int">
		select e.asset_num,e.asset_name,e.iot_num,CONVERT(image USING utf8mb4) AS imageBase64,e.create_time,e.user,e.responsible  from eam_asset e where e.asset_id = #{assetId}
	</select>

	<select id="queryCountByAssetId" resultType="int" parameterType="int">
		select count(asset_id) from eam_asset where asset_id = #{assetId}
	</select>


	<delete id="rmEamAsset" parameterType="int">
		delete from eam_asset where asset_id=#{assetId}
	</delete>


	<update id="bindEamTag" parameterType="Map">
		update eam_asset set iot_num = #{iot_num} where asset_id=#{asset_id}
	</update>


	<select id="listEamAssetByIotNum" resultType="Map" parameterType="Map">
		select * from eam_asset e where iot_num=#{iot_num}

	</select>

	<select id="countEamAssetByPage" resultType="int" parameterType="Map">
		select count(*) from eam_asset e
		where 1=1
		<if test="keyword != null and keyword!=''">
			and (e.asset_id like '%${keyword}%' or e.asset_num like '%${keyword}%' or e.asset_name like '%${keyword}%' or e.iot_num like '%${keyword}%')
		</if>
	</select>

	<select id="listEamAssetByPage" resultType="Map" parameterType="Map">
		select * ,CONVERT(image USING utf8mb4) AS imageBase64 from eam_asset e
		where 1=1
		<if test="keyword != null and keyword!=''">
			and (e.asset_id like '%${keyword}%' or e.asset_num like '%${keyword}%' or e.asset_name like '%${keyword}%' or e.iot_num like '%${keyword}%')
		</if>
		limit #{startIndex},#{perPage}
	</select>

	<select id="countBindingEamAssetByPage" resultType="int" parameterType="Map">
		SELECT
		count(e.*)
		FROM
		eam_asset e
		LEFT JOIN eam_gateway_asset g ON g.asset_id = e.asset_id
		<if test="asset_id != null and asset_id!=''">  and e.asset_id like '%${asset_id}%' </if>
		limit #{startIndex},#{perPage}
	</select>

	<select id="listBindingEamAssetByPage" resultType="Map" parameterType="Map">
		SELECT
		e.asset_id,
		e.asset_name,
		e.asset_num,
		e.iot_num,
		e.`user`,
		e.responsible,
		g.gateway_id
		FROM
		eam_asset e
		LEFT JOIN eam_gateway_asset g ON g.asset_id = e.asset_id
		<if test="asset_id != null and asset_id!=''">  and e.asset_id like '%${asset_id}%' </if>
		limit #{startIndex},#{perPage}
	</select>


	<select id="countAssetNoBindGateway" resultType="int" parameterType="Map">
		SELECT count(1) FROM eam_asset e
		WHERE NOT EXISTS
		(SELECT 1 FROM eam_gateway_asset g
		WHERE e.asset_id = g.asset_id
		)
		limit #{startIndex},#{perPage}
	</select>

	<select id="listAssetNoBindGateway" resultType="Map" parameterType="Map">
		SELECT e.* FROM eam_asset e
		WHERE NOT EXISTS
		(SELECT 1 FROM eam_gateway_asset g
		WHERE e.asset_id = g.asset_id
		)
		limit #{startIndex},#{perPage}
	</select>

</mapper>
